<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LoL Live Client Data Proxy</title>
  <link rel="icon" href="favicon.svg" type="image/svg+xml">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #0a0e17;
      color: #e0e6ed;
      min-height: 100vh;
    }

    .header {
      background: linear-gradient(135deg, #1a1f35 0%, #0d1117 100%);
      border-bottom: 1px solid rgba(201, 170, 113, 0.3);
      padding: 20px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header h1 {
      font-size: 22px;
      font-weight: 600;
      background: linear-gradient(135deg, #c9aa71, #f0d692);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: 1px;
    }

    .status-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
    }

    .status-badge.online {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
      border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .status-badge.offline {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    .online .status-dot { background: #22c55e; }
    .offline .status-dot { background: #ef4444; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .card {
      background: linear-gradient(145deg, #141924, #0f1320);
      border: 1px solid rgba(201, 170, 113, 0.12);
      border-radius: 12px;
      padding: 20px;
      transition: border-color 0.3s;
    }

    .card:hover {
      border-color: rgba(201, 170, 113, 0.3);
    }

    .card-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: #8892a4;
      margin-bottom: 8px;
    }

    .card-value {
      font-size: 28px;
      font-weight: 700;
      color: #c9aa71;
    }

    .card-value.small {
      font-size: 18px;
    }

    .section {
      background: linear-gradient(145deg, #141924, #0f1320);
      border: 1px solid rgba(201, 170, 113, 0.12);
      border-radius: 12px;
      margin-bottom: 24px;
      overflow: hidden;
    }

    .section-header {
      padding: 16px 20px;
      border-bottom: 1px solid rgba(201, 170, 113, 0.1);
      font-size: 15px;
      font-weight: 600;
      color: #c9aa71;
    }

    .player-table {
      width: 100%;
      border-collapse: collapse;
    }

    .player-table th {
      text-align: left;
      padding: 10px 16px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #8892a4;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .player-table td {
      padding: 10px 16px;
      font-size: 14px;
      border-bottom: 1px solid rgba(255,255,255,0.03);
    }

    .player-table tr:hover td {
      background: rgba(201, 170, 113, 0.04);
    }

    .team-order { color: #3b82f6; }
    .team-chaos { color: #ef4444; }

    .kda {
      font-weight: 600;
      font-variant-numeric: tabular-nums;
    }

    .events-list {
      max-height: 300px;
      overflow-y: auto;
      padding: 12px 20px;
    }

    .events-list::-webkit-scrollbar {
      width: 4px;
    }

    .events-list::-webkit-scrollbar-thumb {
      background: rgba(201, 170, 113, 0.3);
      border-radius: 2px;
    }

    .event-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.03);
      font-size: 13px;
      line-height: 1.5;
    }

    .event-time {
      color: #8892a4;
      font-variant-numeric: tabular-nums;
      min-width: 50px;
      flex-shrink: 0;
    }

    .event-icon {
      font-size: 16px;
      min-width: 22px;
      text-align: center;
      flex-shrink: 0;
    }

    .event-detail {
      flex: 1;
    }

    .event-killer { color: #ef4444; font-weight: 600; }
    .event-victim { color: #3b82f6; font-weight: 600; }
    .event-assist { color: #8892a4; font-size: 12px; }
    .event-label { color: #c9aa71; font-weight: 600; }
    .event-multi { color: #a855f7; font-weight: 700; font-size: 12px; }

    .waiting-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 60vh;
      text-align: center;
    }

    .waiting-icon {
      font-size: 64px;
      margin-bottom: 24px;
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .waiting-text {
      font-size: 20px;
      color: #8892a4;
      margin-bottom: 8px;
    }

    .waiting-sub {
      font-size: 14px;
      color: #555e6e;
    }

    .api-list {
      padding: 16px 20px;
    }

    .api-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.03);
      font-size: 13px;
    }

    .api-method {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 700;
      font-family: monospace;
    }

    .api-path {
      font-family: 'Fira Code', 'Cascadia Code', monospace;
      color: #a0aab8;
    }

    .api-path a {
      color: inherit;
      text-decoration: none;
    }

    .api-path a:hover {
      color: #c9aa71;
    }

    .ws-badge {
      background: rgba(168, 85, 247, 0.15);
      color: #a855f7;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 700;
      font-family: monospace;
    }

    .connection-info {
      font-size: 12px;
      color: #555e6e;
      padding: 8px 32px 8px;
      text-align: right;
    }
    .lang-switch {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #e0e6ed;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      margin-left: 12px;
      transition: all 0.2s;
    }

    .lang-switch:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    .debug-btn {
      background: #ef4444;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.2s;
    }
    .debug-btn:hover {
      background: #dc2626;
      transform: scale(1.05);
    }
    .debug-btn:active {
      transform: scale(0.95);
    }

    /* Audio Player */
    .audio-player {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(180deg, #1a1f35 0%, #0d1117 100%);
      border-top: 1px solid rgba(201, 170, 113, 0.3);
      padding: 12px 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      z-index: 1000;
      transform: translateY(100%);
      transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .audio-player.visible {
      transform: translateY(0);
    }
    .audio-player .controls {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-shrink: 0;
    }
    .audio-player .ctrl-btn {
      background: none;
      border: 1px solid rgba(201, 170, 113, 0.3);
      color: #c9aa71;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: all 0.2s;
    }
    .ctrl-btn:hover {
      background: rgba(201, 170, 113, 0.15);
      border-color: #c9aa71;
    }
    .ctrl-btn.play-btn {
      width: 42px;
      height: 42px;
      font-size: 18px;
      background: rgba(201, 170, 113, 0.1);
    }
    .audio-player .track-info {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .audio-player .track-text {
      font-size: 13px;
      color: #e0e6ed;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .audio-player .progress-bar {
      width: 100%;
      height: 4px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 2px;
      cursor: pointer;
      position: relative;
    }
    .audio-player .progress-bar:hover {
      height: 6px;
    }
    .audio-player .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #c9aa71, #f0d692);
      border-radius: 2px;
      transition: width 0.1s linear;
      position: relative;
    }
    .audio-player .progress-fill::after {
      content: '';
      position: absolute;
      right: -5px;
      top: 50%;
      transform: translateY(-50%);
      width: 10px;
      height: 10px;
      background: #f0d692;
      border-radius: 50%;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .audio-player .progress-bar:hover .progress-fill::after {
      opacity: 1;
    }
    .audio-player .time-display {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: #8892a4;
      font-variant-numeric: tabular-nums;
    }
    .audio-player .provider-badge {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 4px;
      font-weight: 600;
      text-transform: uppercase;
      flex-shrink: 0;
    }
    .provider-badge.elevenlabs {
      background: rgba(168, 85, 247, 0.15);
      color: #a855f7;
      border: 1px solid rgba(168, 85, 247, 0.3);
    }
    .provider-badge.edge {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
      border: 1px solid rgba(34, 197, 94, 0.3);
    }
    .audio-player .close-btn {
      background: none;
      border: none;
      color: #555e6e;
      cursor: pointer;
      font-size: 18px;
      padding: 4px;
      transition: color 0.2s;
    }
    .close-btn:hover {
      color: #ef4444;
    }
    /* History list */
    .audio-history {
      position: fixed;
      bottom: 76px;
      right: 24px;
      width: 360px;
      max-height: 300px;
      overflow-y: auto;
      background: linear-gradient(145deg, #141924, #0f1320);
      border: 1px solid rgba(201, 170, 113, 0.2);
      border-radius: 12px;
      z-index: 999;
      display: none;
    }
    .audio-history.visible {
      display: block;
    }
    .audio-history-item {
      padding: 10px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.03);
      cursor: pointer;
      font-size: 13px;
      color: #a0aab8;
      transition: background 0.15s;
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .audio-history-item:hover {
      background: rgba(201, 170, 113, 0.08);
      color: #e0e6ed;
    }
    .audio-history-item .history-icon {
      flex-shrink: 0;
      font-size: 14px;
    }
    .audio-history-item .history-text {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .audio-history-item .history-time {
      font-size: 11px;
      color: #555e6e;
      flex-shrink: 0;
    }
    body { padding-bottom: 70px; } /* Space for fixed player */

    /* Settings Modal */
    .settings-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
    }
    .settings-overlay.visible { display: flex; }
    .settings-panel {
      background: linear-gradient(145deg, #1a1f35, #0f1320);
      border: 1px solid rgba(201, 170, 113, 0.25);
      border-radius: 16px;
      width: 520px;
      max-height: 85vh;
      overflow-y: auto;
      padding: 28px;
    }
    .settings-panel h2 {
      font-size: 18px;
      color: #c9aa71;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .settings-panel h2 button {
      background: none;
      border: none;
      color: #555;
      font-size: 20px;
      cursor: pointer;
    }
    .settings-panel h2 button:hover { color: #ef4444; }
    .settings-group {
      margin-bottom: 20px;
      padding: 16px;
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 10px;
    }
    .settings-group-title {
      font-size: 13px;
      font-weight: 600;
      color: #8892a4;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
    }
    .settings-field {
      margin-bottom: 12px;
    }
    .settings-field:last-child { margin-bottom: 0; }
    .settings-field label {
      display: block;
      font-size: 12px;
      color: #8892a4;
      margin-bottom: 4px;
    }
    .settings-field input, .settings-field select {
      width: 100%;
      padding: 8px 12px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      color: #e0e6ed;
      font-size: 13px;
      font-family: 'SF Mono', 'Fira Code', monospace;
      outline: none;
      transition: border-color 0.2s;
    }
    .settings-field input:focus, .settings-field select:focus {
      border-color: rgba(201, 170, 113, 0.5);
    }
    .settings-field input::placeholder { color: #555e6e; }
    .settings-field .hint {
      font-size: 11px;
      color: #555e6e;
      margin-top: 3px;
    }
    .settings-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .settings-toggle label { margin-bottom: 0; }
    .toggle-switch {
      position: relative;
      width: 40px;
      height: 22px;
    }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider {
      position: absolute;
      inset: 0;
      background: #2a2f3f;
      border-radius: 11px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .toggle-slider::before {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      left: 3px;
      top: 3px;
      background: #888;
      border-radius: 50%;
      transition: all 0.3s;
    }
    .toggle-switch input:checked + .toggle-slider {
      background: rgba(201, 170, 113, 0.3);
    }
    .toggle-switch input:checked + .toggle-slider::before {
      background: #c9aa71;
      transform: translateX(18px);
    }
    .settings-save {
      width: 100%;
      padding: 10px;
      background: linear-gradient(135deg, #c9aa71, #a8893e);
      color: #0a0e17;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .settings-save:hover { opacity: 0.9; }
    .settings-save:disabled { opacity: 0.5; cursor: not-allowed; }
    .settings-status {
      text-align: center;
      font-size: 12px;
      margin-top: 8px;
      min-height: 16px;
    }
    .settings-status.success { color: #22c55e; }
    .settings-status.error { color: #ef4444; }
    .settings-btn {
      background: none;
      border: 1px solid rgba(201, 170, 113, 0.3);
      color: #c9aa71;
      width: 32px;
      height: 32px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .settings-btn:hover {
      background: rgba(201, 170, 113, 0.15);
    }
  </style>
</head>
<body>
  <div class="header">
    <div style="display: flex; align-items: center; gap: 12px;">
      <div style="display: flex; align-items: center;">
        <img src="favicon.svg" alt="icon" style="height: 32px; width: 32px; margin-right: 12px;">
        <h1 data-i18n="title">LoL Live Client Data Proxy</h1>
      </div>
      <button id="langSwitch" class="lang-switch" onclick="toggleLanguage()">EN / ‰∏≠</button>
      <button class="settings-btn" onclick="openSettings()" title="Settings">‚öôÔ∏è</button>
    </div>
    <div id="statusBadge" class="status-badge offline">
      <span class="status-dot"></span>
      <span id="statusText" data-i18n="status.waiting">Á≠âÂæÖËøûÊé•...</span>
    </div>
  </div>

  <div class="connection-info">
    <span data-i18n="ws.label">WebSocket:</span> <span id="wsStatus" data-i18n="ws.connecting">ËøûÊé•‰∏≠...</span>
  </div>

  <div class="container">
    <!-- Waiting Screen (shown when no game) -->
    <div id="waitingScreen" class="waiting-screen">
      <div class="waiting-icon">üéÆ</div>
      <div class="waiting-text" data-i18n="waiting.title">Á≠âÂæÖ LoL Ê∏∏ÊàèÂêØÂä®...</div>
      <div class="waiting-sub" data-i18n="waiting.desc">ÂΩìÊ∏∏ÊàèÂºÄÂßãÂêéÔºåÊï∞ÊçÆÂ∞ÜËá™Âä®ÊòæÁ§∫Âú®ËøôÈáå</div>

      <div id="debug-section" class="section" style="margin-top: 40px; width: 100%; max-width: 600px; display: none;">
        <div class="section-header">üß™ Debug</div>
        <div style="padding: 20px; text-align: center; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
          <button class="debug-btn" onclick="triggerDebugRoast('DEATH')">üíÄ Ê®°ÊãüÊ≠ª‰∫°</button>
          <button class="debug-btn" style="background: #2ecc71;" onclick="triggerDebugRoast('KILL')">‚öîÔ∏è Ê®°ÊãüÂáªÊùÄ</button>
          <button class="debug-btn" style="background: #f1c40f; color: #000;" onclick="triggerDebugRoast('CS_GAP')">üí∞ Ê®°ÊãüÊºèÂàÄ</button>
          <button class="debug-btn" style="background: #9b59b6;" onclick="triggerDebugRoast('TEAMMATE_DEATH')">üê∑ ÈòüÂèãË¢´ÊùÄ</button>
          <button class="debug-btn" style="background: #3498db;" onclick="triggerDebugRoast('OBJECTIVE')">üêâ Ê®°ÊãüÊãøÈæô</button>
          <button class="debug-btn" style="background: #2ecc71;" onclick="triggerDebugRoast('LLM_TEST')">ü§ñ ÊµãËØï AI Âò≤ËÆΩ (LLM)</button>
        </div>
      </div>

      <div class="section" style="margin-top: 40px; width: 100%; max-width: 600px;">
        <div class="section-header" data-i18n="api.title">üìã API Á´ØÁÇπ</div>
        <div class="api-list">
          <div class="api-item">
            <span class="api-method">GET</span>
            <span class="api-path"><a href="/status">/status</a></span>
          </div>
          <div class="api-item">
            <span class="api-method">GET</span>
            <span class="api-path"><a href="/liveclientdata/allgamedata">/liveclientdata/allgamedata</a></span>
          </div>
          <div class="api-item">
            <span class="api-method">GET</span>
            <span class="api-path"><a href="/liveclientdata/activeplayer">/liveclientdata/activeplayer</a></span>
          </div>
          <div class="api-item">
            <span class="api-method">GET</span>
            <span class="api-path"><a href="/liveclientdata/playerlist">/liveclientdata/playerlist</a></span>
          </div>
          <div class="api-item">
            <span class="api-method">GET</span>
            <span class="api-path"><a href="/liveclientdata/eventdata">/liveclientdata/eventdata</a></span>
          </div>
          <div class="api-item">
            <span class="api-method">GET</span>
            <span class="api-path"><a href="/liveclientdata/gamestats">/liveclientdata/gamestats</a></span>
          </div>
          <div class="api-item">
            <span class="ws-badge">WS</span>
            <span class="api-path">/ws</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Game Data Screen (shown when game is running) -->
    <div id="gameScreen" style="display: none;">
      <div class="grid">
        <div class="card">
          <div class="card-label" data-i18n="card.time">Ê∏∏ÊàèÊó∂Èó¥</div>
          <div class="card-value" id="gameTime">--:--</div>
        </div>
        <div class="card">
          <div class="card-label" data-i18n="card.mode">Ê∏∏ÊàèÊ®°Âºè</div>
          <div class="card-value small" id="gameMode">--</div>
        </div>
        <div class="card">
          <div class="card-label" data-i18n="card.map">Âú∞Âõæ</div>
          <div class="card-value small" id="mapName">--</div>
        </div>
      </div>

      <!-- Active Player -->
      <div class="section">
        <div class="section-header" data-i18n="player.title">üèÜ ÂΩìÂâçÁé©ÂÆ∂</div>
        <div style="padding: 16px 20px;">
          <div id="activePlayer" style="font-size: 14px; color: #a0aab8;" data-i18n="loading">Âä†ËΩΩ‰∏≠...</div>
        </div>
      </div>

      <!-- Player List -->
      <div class="section">
        <div class="section-header" data-i18n="all_players.title">üë• ÊâÄÊúâÁé©ÂÆ∂</div>
        <div style="overflow-x: auto;">
          <table class="player-table">
            <thead>
              <tr>
                <th data-i18n="table.team">Èòü‰ºç</th>
                <th data-i18n="table.summoner">Âè¨Âî§Â∏à</th>
                <th data-i18n="table.champion">Ëã±ÈõÑ</th>
                <th data-i18n="table.level">Á≠âÁ∫ß</th>
                <th>KDA</th>
                <th>CS</th>
              </tr>
            </thead>
            <tbody id="playerList"></tbody>
          </table>
        </div>
      </div>

      <!-- Events -->
      <div class="section">
        <div class="section-header" data-i18n="events.title">üìú Ê∏∏Êàè‰∫ã‰ª∂</div>
        <div class="events-list" id="eventsList"></div>
      </div>
    </div>
  </div>

  <!-- Audio Player -->
  <div id="audioPlayer" class="audio-player">
    <div class="controls">
      <button class="ctrl-btn play-btn" id="playPauseBtn" onclick="togglePlayPause()" title="Play/Pause">‚ñ∂</button>
      <button class="ctrl-btn" onclick="replayAudio()" title="Replay">‚Ü∫</button>
      <button class="ctrl-btn" onclick="toggleHistory()" title="History">üìã</button>
    </div>
    <div class="track-info">
      <div class="track-text" id="trackText">--</div>
      <div class="progress-bar" id="progressBar" onclick="seekAudio(event)">
        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
      </div>
      <div class="time-display">
        <span id="currentTime">0:00</span>
        <span id="totalTime">0:00</span>
      </div>
    </div>
    <span id="providerBadge" class="provider-badge">--</span>
    <button class="close-btn" onclick="closePlayer()" title="Close">‚úï</button>
  </div>

  <!-- Audio History -->
  <div id="audioHistory" class="audio-history">
  </div>

  <!-- Settings Modal -->
  <div id="settingsOverlay" class="settings-overlay" onclick="if(event.target===this)closeSettings()">
    <div class="settings-panel">
      <h2>‚öôÔ∏è Settings <button onclick="closeSettings()">‚úï</button></h2>

      <div class="settings-group">
        <div class="settings-group-title">ü§ñ LLM (AI Coach)</div>
        <div class="settings-field settings-toggle">
          <label>Enable AI Coach</label>
          <label class="toggle-switch">
            <input type="checkbox" id="sLlmEnabled">
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="settings-field">
          <label>Base URL</label>
          <input id="sLlmBaseUrl" placeholder="https://generativelanguage.googleapis.com/v1beta/openai/">
          <div class="hint">OpenAI-compatible endpoint. Works with Gemini, OpenAI, DeepSeek, Ollama, etc.</div>
        </div>
        <div class="settings-field">
          <label>API Key</label>
          <input id="sLlmApiKey" type="password" placeholder="Enter API key">
          <div class="hint">Leave empty to keep current key unchanged</div>
        </div>
        <div class="settings-field">
          <label>Model</label>
          <input id="sLlmModel" placeholder="gemini-2.0-flash">
        </div>
      </div>

      <div class="settings-group">
        <div class="settings-group-title">üó£Ô∏è TTS (Text-to-Speech)</div>
        <div class="settings-field">
          <label>Provider</label>
          <select id="sTtsProvider">
            <option value="edge">Edge TTS (Free)</option>
            <option value="elevenlabs">ElevenLabs (Premium)</option>
          </select>
        </div>
        <div id="elevenlabsSettings">
          <div class="settings-field">
            <label>ElevenLabs API Key</label>
            <input id="sElevenlabsApiKey" type="password" placeholder="Enter ElevenLabs API key">
            <div class="hint">Leave empty to keep current key unchanged</div>
          </div>
          <div class="settings-field">
            <label>Voice ID</label>
            <input id="sElevenlabsVoiceId" placeholder="5mZxJZhSmJTjL7GoYfYI">
            <div class="hint">Browse voices: elevenlabs.io/voice-library</div>
          </div>
        </div>
      </div>

      <button class="settings-save" onclick="saveSettings()">Save Settings</button>
      <div id="settingsStatus" class="settings-status"></div>
    </div>
  </div>

  <script>
    const i18n = {
      zh: {
        title: "LoL Live Client Data Proxy",
        "status.waiting": "Á≠âÂæÖËøûÊé•...",
        "status.online": "Ê∏∏ÊàèËøõË°å‰∏≠",
        "status.offline": "Á≠âÂæÖÊ∏∏Êàè...",
        "ws.label": "WebSocket:",
        "ws.connecting": "ËøûÊé•‰∏≠...",
        "ws.connected": "Â∑≤ËøûÊé• ‚úì",
        "ws.disconnected": "Â∑≤Êñ≠ÂºÄ (ÈáçËøû‰∏≠...)",
        "waiting.title": "Á≠âÂæÖ LoL Ê∏∏ÊàèÂêØÂä®...",
        "waiting.desc": "ÂΩìÊ∏∏ÊàèÂºÄÂßãÂêéÔºåÊï∞ÊçÆÂ∞ÜËá™Âä®ÊòæÁ§∫Âú®ËøôÈáå",
        "api.title": "üìã API Á´ØÁÇπ",
        "card.time": "Ê∏∏ÊàèÊó∂Èó¥",
        "card.mode": "Ê∏∏ÊàèÊ®°Âºè",
        "card.map": "Âú∞Âõæ",
        "player.title": "üèÜ ÂΩìÂâçÁé©ÂÆ∂",
        "loading": "Âä†ËΩΩ‰∏≠...",
        "player.gold": "ÂΩìÂâçÈáëÂ∏Å",
        "player.ad": "ÊîªÂáªÂäõ",
        "player.ap": "Ê≥ïÂº∫",
        "player.armor": "Êä§Áî≤",
        "player.mr": "È≠îÊäó",
        "all_players.title": "üë• ÊâÄÊúâÁé©ÂÆ∂",
        "table.team": "Èòü‰ºç",
        "table.summoner": "Âè¨Âî§Â∏à",
        "table.champion": "Ëã±ÈõÑ",
        "table.level": "Á≠âÁ∫ß",
        "team.order": "ËìùÈòü",
        "team.chaos": "Á∫¢Èòü",
        "events.title": "üìú Ê∏∏Êàè‰∫ã‰ª∂",
        "event.kill": "ÂáªÊùÄ‰∫Ü",
        "event.assist": "Âä©Êîª",
        "event.multikill.2": "ÂèåÊùÄ",
        "event.multikill.3": "‰∏âÊùÄ",
        "event.multikill.4": "ÂõõÊùÄ",
        "event.multikill.5": "‰∫îÊùÄ",
        "event.multikill.x": "ËøûÊùÄ",
        "event.ace": "Âõ¢ÁÅ≠!",
        "event.ace_desc": "ÂÆåÊàê‰∫ÜÂõ¢ÁÅ≠",
        "event.firstblood": "Á¨¨‰∏ÄÊª¥Ë°Ä!",
        "event.turret": "Èò≤Âæ°Â°î",
        "event.inhib": "Ê∞¥Êô∂",
        "event.destroy": "ÊëßÊØÅ‰∫Ü",
        "event.inhib_soon": "Ê∞¥Êô∂Âç≥Â∞ÜÈáçÁîü",
        "event.inhib_respawn": "Ê∞¥Êô∂Â∑≤ÈáçÁîü",
        "event.dragon": "Â∑®Èæô",
        "event.dragon.Fire": "ÁÅ´Èæô",
        "event.dragon.Water": "Ê∞¥Èæô",
        "event.dragon.Earth": "ÂúüÈæô",
        "event.dragon.Air": "È£éÈæô",
        "event.dragon.Hextech": "Êµ∑ÂÖãÊñØÈæô",
        "event.dragon.Chemtech": "ÂåñÂ≠¶Èæô",
        "event.dragon.Elder": "ËøúÂè§Â∑®Èæô",
        "event.herald": "Â≥°Ë∞∑ÂÖàÈîã",
        "event.baron": "Á∫≥‰ªÄÁî∑Áàµ",
        "event.stolen": "(ÂÅ∑Âèñ!)",
        "event.start": "Ê∏∏ÊàèÂºÄÂßã",
        "event.end": "Ê∏∏ÊàèÁªìÊùü",
        "event.win": "ËÉúÂà©",
        "event.loss": "Â§±Ë¥•",
        "event.minions": "Â∞èÂÖµÂ∑≤Âá∫Âèë",
        "unknown": "Êú™Áü•",
        "minion": "Â∞èÂÖµ"
      },
      en: {
        title: "LoL Live Client Data Proxy",
        "status.waiting": "Waiting for connection...",
        "status.online": "Game Running",
        "status.offline": "Waiting for Game...",
        "ws.label": "WebSocket:",
        "ws.connecting": "Connecting...",
        "ws.connected": "Connected ‚úì",
        "ws.disconnected": "Disconnected (Reconnecting...)",
        "waiting.title": "Waiting for LoL Client...",
        "waiting.desc": "Data will appear here automatically when the game starts",
        "api.title": "üìã API Endpoints",
        "card.time": "Game Time",
        "card.mode": "Game Mode",
        "card.map": "Map",
        "player.title": "üèÜ Active Player",
        "loading": "Loading...",
        "player.gold": "Gold",
        "player.ad": "AD",
        "player.ap": "AP",
        "player.armor": "Armor",
        "player.mr": "MR",
        "all_players.title": "üë• All Players",
        "table.team": "Team",
        "table.summoner": "Summoner",
        "table.champion": "Champion",
        "table.level": "Level",
        "team.order": "Order",
        "team.chaos": "Chaos",
        "events.title": "üìú Game Events",
        "event.kill": "killed",
        "event.assist": "Assist",
        "event.multikill.2": "Double Kill",
        "event.multikill.3": "Triple Kill",
        "event.multikill.4": "Quadra Kill",
        "event.multikill.5": "Penta Kill",
        "event.multikill.x": "Multi Kill",
        "event.ace": "Ace!",
        "event.ace_desc": "scored an Ace",
        "event.firstblood": "First Blood!",
        "event.turret": "Turret",
        "event.inhib": "Inhibitor",
        "event.destroy": "destroyed",
        "event.inhib_soon": "Inhibitor Respawning Soon",
        "event.inhib_respawn": "Inhibitor Respawned",
        "event.dragon": "Dragon",
        "event.dragon.Fire": "Infernal Drake",
        "event.dragon.Water": "Ocean Drake",
        "event.dragon.Earth": "Mountain Drake",
        "event.dragon.Air": "Cloud Drake",
        "event.dragon.Hextech": "Hextech Drake",
        "event.dragon.Chemtech": "Chemtech Drake",
        "event.dragon.Elder": "Elder Dragon",
        "event.herald": "Rift Herald",
        "event.baron": "Baron Nashor",
        "event.stolen": "(Stolen!)",
        "event.start": "Game Started",
        "event.end": "Game Ended",
        "event.win": "Victory",
        "event.loss": "Defeat",
        "event.minions": "Minions have spawned",
        "unknown": "Unknown",
        "minion": "Minion"
      }
    };

    let currentLang = localStorage.getItem('lol-proxy-lang') || 'zh';

    function t(key) {
      return i18n[currentLang][key] || key;
    }

    function setLanguage(lang) {
      currentLang = lang;
      localStorage.setItem('lol-proxy-lang', lang);
      document.documentElement.lang = lang === 'zh' ? 'zh-CN' : 'en';

      // Sync with backend
      fetch('/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ language: lang })
      }).catch(console.error);

      // Update static elements
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        el.textContent = t(key);
      });

      // Re-render dynamic content if we have data
      if (lastGameData) {
        updateGameData(lastGameData);
      }
    }
    // --- Settings ---
    function openSettings() {
      fetch('/settings')
        .then(r => r.json())
        .then(data => {
          document.getElementById('sLlmEnabled').checked = data.llmEnabled;
          document.getElementById('sLlmBaseUrl').value = data.llmBaseUrl || '';
          document.getElementById('sLlmApiKey').value = '';
          document.getElementById('sLlmApiKey').placeholder = data.llmApiKey || 'Enter API key';
          document.getElementById('sLlmModel').value = data.llmModel || '';
          document.getElementById('sTtsProvider').value = data.ttsProvider || 'edge';
          document.getElementById('sElevenlabsApiKey').value = '';
          document.getElementById('sElevenlabsApiKey').placeholder = data.elevenlabsApiKey || 'Enter API key';
          document.getElementById('sElevenlabsVoiceId').value = data.elevenlabsVoiceId || '';
          toggleElevenlabsFields();
          document.getElementById('settingsStatus').textContent = '';
          document.getElementById('settingsOverlay').classList.add('visible');
        })
        .catch(e => console.error('Failed to load settings:', e));
    }

    function closeSettings() {
      document.getElementById('settingsOverlay').classList.remove('visible');
    }

    function toggleElevenlabsFields() {
      const show = document.getElementById('sTtsProvider').value === 'elevenlabs';
      document.getElementById('elevenlabsSettings').style.display = show ? 'block' : 'none';
    }

    // Bind provider change
    document.getElementById('sTtsProvider').addEventListener('change', toggleElevenlabsFields);

    function saveSettings() {
      const btn = document.querySelector('.settings-save');
      const status = document.getElementById('settingsStatus');
      btn.disabled = true;
      status.textContent = 'Saving...';
      status.className = 'settings-status';

      const body = {};
      body.llmEnabled = document.getElementById('sLlmEnabled').checked;
      const baseUrl = document.getElementById('sLlmBaseUrl').value.trim();
      if (baseUrl) body.llmBaseUrl = baseUrl;
      const apiKey = document.getElementById('sLlmApiKey').value.trim();
      if (apiKey) body.llmApiKey = apiKey;
      const model = document.getElementById('sLlmModel').value.trim();
      if (model) body.llmModel = model;
      body.ttsProvider = document.getElementById('sTtsProvider').value;
      const elKey = document.getElementById('sElevenlabsApiKey').value.trim();
      if (elKey) body.elevenlabsApiKey = elKey;
      const voiceId = document.getElementById('sElevenlabsVoiceId').value.trim();
      if (voiceId) body.elevenlabsVoiceId = voiceId;

      fetch('/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      })
      .then(r => r.json())
      .then(data => {
        btn.disabled = false;
        if (data.status === 'ok') {
          status.textContent = '‚úì Settings saved!';
          status.className = 'settings-status success';
          setTimeout(() => closeSettings(), 1500);
        } else {
          status.textContent = '‚úó ' + (data.message || 'Failed');
          status.className = 'settings-status error';
        }
      })
      .catch(e => {
        btn.disabled = false;
        status.textContent = '‚úó Network error';
        status.className = 'settings-status error';
      });
    }

    function toggleLanguage() {
      setLanguage(currentLang === 'zh' ? 'en' : 'zh');
    }

    const statusBadge = document.getElementById('statusBadge');
    const statusText = document.getElementById('statusText');
    const wsStatus = document.getElementById('wsStatus');
    const waitingScreen = document.getElementById('waitingScreen');
    const gameScreen = document.getElementById('gameScreen');

    let ws;
    let reconnectTimer;
    let lastGameData = null;

    function connectWebSocket() {
      const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${location.host}/ws`);

      ws.onopen = () => {
        wsStatus.textContent = t('ws.connected');
        wsStatus.style.color = '#22c55e';
      };

      ws.onclose = () => {
        wsStatus.textContent = t('ws.disconnected');
        wsStatus.style.color = '#ef4444';
        clearTimeout(reconnectTimer);
        reconnectTimer = setTimeout(connectWebSocket, 3000);
      };

      ws.onerror = () => {
        ws.close();
      };

      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);

        switch (msg.type) {
          case 'status':
            updateGameStatus(msg.gameRunning);
            break;
          case 'gameStarted':
            updateGameStatus(true);
            break;
          case 'gameEnded':
            updateGameStatus(false);
            break;
          case 'gameData':
            updateGameStatus(true);
            lastGameData = msg.data;
            updateGameData(msg.data);
            break;
          case 'audioReady':
            playAudio(msg.url, msg.text);
            addToHistory(msg.text, msg.url);
            break;
        }
      };
    }

    function updateGameStatus(running) {
      if (running) {
        statusBadge.className = 'status-badge online';
        statusText.textContent = t('status.online');
        waitingScreen.style.display = 'none';
        gameScreen.style.display = 'block';
      } else {
        statusBadge.className = 'status-badge offline';
        statusText.textContent = t('status.offline');
        waitingScreen.style.display = 'flex';
        gameScreen.style.display = 'none';
      }
    }

    function formatTime(seconds) {
      const m = Math.floor(seconds / 60);
      const s = Math.floor(seconds % 60);
      return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    }

    function updateGameData(data) {
      // Game stats
      if (data.gameData) {
        document.getElementById('gameTime').textContent = formatTime(data.gameData.gameTime);
        document.getElementById('gameMode').textContent = data.gameData.gameMode || '--';
        document.getElementById('mapName').textContent = data.gameData.mapName || '--';
      }

      // Active player
      if (data.activePlayer) {
        const ap = data.activePlayer;
        const stats = ap.championStats || {};
        document.getElementById('activePlayer').innerHTML = `
          <div style="display: flex; gap: 24px; flex-wrap: wrap;">
            <div><strong style="color: #c9aa71;">${ap.riotIdGameName || ap.summonerName || '--'}</strong></div>
            <div>${t('table.level')}: <strong>${ap.level || '--'}</strong></div>
            <div>${t('player.gold')}: <strong style="color: #f0d692;">${Math.floor(ap.currentGold || 0)}</strong></div>
            <div>${t('player.ad')}: ${Math.floor(stats.attackDamage || 0)}</div>
            <div>${t('player.ap')}: ${Math.floor(stats.abilityPower || 0)}</div>
            <div>${t('player.armor')}: ${Math.floor(stats.armor || 0)}</div>
            <div>${t('player.mr')}: ${Math.floor(stats.magicResist || 0)}</div>
          </div>
        `;
      }

      // Player list
      if (data.allPlayers) {
        const tbody = document.getElementById('playerList');
        tbody.innerHTML = data.allPlayers.map(p => {
          const teamClass = p.team === 'ORDER' ? 'team-order' : 'team-chaos';
          const teamName = p.team === 'ORDER' ? t('team.order') : t('team.chaos');
          const scores = p.scores || {};
          return `
            <tr>
              <td class="${teamClass}">${teamName}</td>
              <td>${p.riotIdGameName || p.summonerName || '--'}</td>
              <td>${p.championName || '--'}</td>
              <td>${p.level || '--'}</td>
              <td class="kda">${scores.kills || 0}/${scores.deaths || 0}/${scores.assists || 0}</td>
              <td>${scores.creepScore || 0}</td>
            </tr>
          `;
        }).join('');
      }

      // Events
      if (data.events && data.events.Events) {
        const el = document.getElementById('eventsList');
        const events = data.events.Events.slice().reverse();
        el.innerHTML = events.map(e => formatEvent(e)).join('');
      }
    }

    function formatEvent(e) {
      const time = `<span class="event-time">${formatTime(e.EventTime)}</span>`;
      let icon = 'üìå';
      let detail = '';

      const killerName = e.KillerName || t('unknown');
      const victimName = e.VictimName || t('unknown');

      switch (e.EventName) {
        case 'ChampionKill':
          icon = '‚öîÔ∏è';
          detail = `<span class="event-killer">${killerName}</span> ${t('event.kill')} <span class="event-victim">${victimName}</span>`;
          if (e.Assisters && e.Assisters.length > 0) {
            detail += `<br><span class="event-assist">${t('event.assist')}: ${e.Assisters.join(', ')}</span>`;
          }
          break;

        case 'Multikill':
          icon = 'üî•';
          const killKey = `event.multikill.${e.KillStreak}`;
          const killName = t(killKey) !== killKey ? t(killKey) : `${e.KillStreak} ${t('event.multikill.x')}`;
          detail = `<span class="event-killer">${killerName}</span> <span class="event-multi">${killName}!</span>`;
          break;

        case 'Ace':
          icon = 'üíÄ';
          detail = `<span class="event-label">${t('event.ace')}</span> <span class="event-killer">${e.Acer || t('unknown')}</span> ${t('event.ace_desc')}`;
          break;

        case 'FirstBlood':
          icon = 'ü©∏';
          detail = `<span class="event-label">${t('event.firstblood')}</span> <span class="event-killer">${e.Recipient || t('unknown')}</span>`;
          break;

        case 'TurretKilled':
          icon = 'üè∞';
          detail = `<span class="event-killer">${killerName === 'Minion' ? t('minion') : killerName}</span> ${t('event.destroy')} <span class="event-label">${t('event.turret')}</span>`;
          if (e.Assisters && e.Assisters.length > 0) {
            detail += `<br><span class="event-assist">${t('event.assist')}: ${e.Assisters.join(', ')}</span>`;
          }
          break;

        case 'InhibKilled':
          icon = 'üíé';
          detail = `<span class="event-killer">${killerName === 'Minion' ? t('minion') : killerName}</span> ${t('event.destroy')} <span class="event-label">${t('event.inhib')}</span>`;
          if (e.Assisters && e.Assisters.length > 0) {
            detail += `<br><span class="event-assist">${t('event.assist')}: ${e.Assisters.join(', ')}</span>`;
          }
          break;

        case 'InhibRespawningSoon':
          icon = 'üíé';
          detail = `<span class="event-label">${t('event.inhib_soon')}</span>`;
          break;

        case 'InhibRespawned':
          icon = 'üíé';
          detail = `<span class="event-label">${t('event.inhib_respawn')}</span>`;
          break;

        case 'DragonKill':
          icon = 'üêâ';
          const dragonName = t(`event.dragon.${e.DragonType}`) || e.DragonType || t('event.dragon');
          detail = `<span class="event-killer">${killerName}</span> ${t('event.kill')} <span class="event-label">${dragonName}</span>`;
          if (e.Stolen) detail += ` <span class="event-multi">${t('event.stolen')}</span>`;
          if (e.Assisters && e.Assisters.length > 0) {
            detail += `<br><span class="event-assist">${t('event.assist')}: ${e.Assisters.join(', ')}</span>`;
          }
          break;

        case 'HeraldKill':
          icon = 'ü¶Ä';
          detail = `<span class="event-killer">${killerName}</span> ${t('event.kill')} <span class="event-label">${t('event.herald')}</span>`;
          if (e.Stolen) detail += ` <span class="event-multi">${t('event.stolen')}</span>`;
          if (e.Assisters && e.Assisters.length > 0) {
            detail += `<br><span class="event-assist">${t('event.assist')}: ${e.Assisters.join(', ')}</span>`;
          }
          break;

        case 'BaronKill':
          icon = 'üëæ';
          detail = `<span class="event-killer">${killerName}</span> ${t('event.kill')} <span class="event-label">${t('event.baron')}</span>`;
          if (e.Stolen) detail += ` <span class="event-multi">${t('event.stolen')}</span>`;
          if (e.Assisters && e.Assisters.length > 0) {
            detail += `<br><span class="event-assist">${t('event.assist')}: ${e.Assisters.join(', ')}</span>`;
          }
          break;

        case 'GameStart':
          icon = 'üöÄ';
          detail = `<span class="event-label">${t('event.start')}</span>`;
          break;

        case 'GameEnd':
          icon = 'üèÜ';
          const result = e.Result === 'Win' ? t('event.win') : t('event.loss');
          detail = `<span class="event-label">${t('event.end')} ‚Äî ${result}</span>`;
          break;

        case 'MinionsSpawning':
          icon = 'üêõ';
          detail = `<span class="event-label">${t('event.minions')}</span>`;
          break;

        default:
          detail = `<span class="event-label">${e.EventName}</span>`;
          if (e.KillerName) detail += ` ‚Äî ${e.KillerName}`;
          if (e.VictimName) detail += ` ‚Üí ${e.VictimName}`;
          break;
      }

      return `
        <div class="event-item">
          ${time}
          <span class="event-icon">${icon}</span>
          <span class="event-detail">${detail}</span>
        </div>
      `;
    }

    function triggerDebugRoast(type = 'DEATH') {
      fetch('/debug/roast', { 
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ type }) 
      })
        .then(res => res.json())
        .then(data => console.log('Debug Roast:', data))
        .catch(err => console.error('Debug Roast Error:', err));
    }

    // ===================== Audio Player =====================
    const audioEl = new Audio();
    const playerEl = document.getElementById('audioPlayer');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const trackTextEl = document.getElementById('trackText');
    const progressFill = document.getElementById('progressFill');
    const currentTimeEl = document.getElementById('currentTime');
    const totalTimeEl = document.getElementById('totalTime');
    const providerBadge = document.getElementById('providerBadge');
    const audioHistoryEl = document.getElementById('audioHistory');
    let audioHistory = [];

    function fmtTime(sec) {
      if (!sec || isNaN(sec)) return '0:00';
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      return `${m}:${s.toString().padStart(2, '0')}`;
    }

    audioEl.addEventListener('timeupdate', () => {
      if (audioEl.duration) {
        const pct = (audioEl.currentTime / audioEl.duration) * 100;
        progressFill.style.width = pct + '%';
        currentTimeEl.textContent = fmtTime(audioEl.currentTime);
      }
    });

    audioEl.addEventListener('loadedmetadata', () => {
      totalTimeEl.textContent = fmtTime(audioEl.duration);
    });

    audioEl.addEventListener('ended', () => {
      playPauseBtn.textContent = '‚ñ∂';
      progressFill.style.width = '100%';
    });

    function playAudio(url, text) {
      audioEl.src = url;
      audioEl.play();
      playPauseBtn.textContent = '‚è∏';
      trackTextEl.textContent = text || 'Audio';
      playerEl.classList.add('visible');

      // Detect provider from page context
      fetch('/app-info').then(r => r.json()).then(info => {
        // We'll just detect from env - set by server
      }).catch(() => {});
    }

    function togglePlayPause() {
      if (!audioEl.src) return;
      if (audioEl.paused) {
        audioEl.play();
        playPauseBtn.textContent = '‚è∏';
      } else {
        audioEl.pause();
        playPauseBtn.textContent = '‚ñ∂';
      }
    }

    function replayAudio() {
      if (!audioEl.src) return;
      audioEl.currentTime = 0;
      audioEl.play();
      playPauseBtn.textContent = '‚è∏';
    }

    function seekAudio(e) {
      if (!audioEl.duration) return;
      const bar = document.getElementById('progressBar');
      const rect = bar.getBoundingClientRect();
      const pct = (e.clientX - rect.left) / rect.width;
      audioEl.currentTime = pct * audioEl.duration;
    }

    function closePlayer() {
      audioEl.pause();
      playerEl.classList.remove('visible');
      audioHistoryEl.classList.remove('visible');
    }

    function toggleHistory() {
      audioHistoryEl.classList.toggle('visible');
    }

    function addToHistory(text, url) {
      audioHistory.unshift({ text, url, time: new Date() });
      if (audioHistory.length > 20) audioHistory.pop();
      renderHistory();
    }

    function renderHistory() {
      audioHistoryEl.innerHTML = audioHistory.map((item, i) => {
        const ago = getTimeAgo(item.time);
        const shortText = item.text.length > 50 ? item.text.substring(0, 50) + '...' : item.text;
        return `<div class="audio-history-item" onclick="playAudio('${item.url}', '${item.text.replace(/'/g, "\\'")}')"><span class="history-icon">üîä</span><span class="history-text">${shortText}</span><span class="history-time">${ago}</span></div>`;
      }).join('');
    }

    function getTimeAgo(date) {
      const s = Math.floor((Date.now() - date.getTime()) / 1000);
      if (s < 60) return s + 's';
      if (s < 3600) return Math.floor(s / 60) + 'm';
      return Math.floor(s / 3600) + 'h';
    }
    // ===================== End Audio Player =====================

    // Check App Info (Debug Mode)
    fetch('/app-info')
      .then(res => res.json())
      .then(info => {
        if (info.debugEnabled) {
          document.getElementById('debug-section').style.display = 'block';
        }
        // Set provider badge
        providerBadge.textContent = info.ttsProvider || 'edge';
        providerBadge.className = `provider-badge ${(info.ttsProvider || 'edge')}`;
      })
      .catch(console.error);

    // Connect on page load
    setLanguage(currentLang);
    // Initialize language on load (syncs with backend)
    setLanguage(currentLang);

    // Start WebSocket connection
    connectWebSocket();
  </script>
</body>
</html>
